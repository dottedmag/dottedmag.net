
<!doctype html>
<html>
<head>
  
  <meta charset="utf-8">
  <!-- Still needed? -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="author" content="Mikhail Gusarov">
  <title>DE/compositor development notes - Linux VT</title>

  <link rel="stylesheet" href="/styles/main.css">
  <link rel="alternate" type="application/atom+xml" title="Mikhail Gusarov feed" href="../../blog.atom">

  <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-120900398-1">
  </script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-120900398-1');
  </script>

</head>
<body>
  
<header class="site-header" role="banner">
  <div class="wrapper">
    <a class="site-title" href="/">Mikhail Gusarov</a>
    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>
      <div class="trigger">
        <a class="page-link active-page-link" href="/">Blog</a>
        <a class="page-link " href="/cv">CV</a>
        <a class="page-link " href="/keys">Keys</a>
        <a class="page-link " href="/software">Software</a>
        <a class="page-link " href="/contacts">Contacts</a>
      </div>
    </nav>
  </div>
</header>

  <main class="page-content">
    <div class="wrapper">
      
<article class="post">
  <h1>DE/compositor development notes - Linux VT</h1>
  <div class="post-content">
  <p>Before drawing any visuals on screen, the compositor must ensure it
owns the screen it wishes to draw on. If it doesn&rsquo;t, the results
won&rsquo;t look good, as multiple processes or the kernel may draw over
the compositor&rsquo;s output<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.</p>
<p>In Linux, VT subsystem draws terminals across multiple screens
attached to computer<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>, so the compositor needs to cooperate
with it. The VT subsystem emulates multiple physical consoles on a single
display, providing functionality to add, destroy and switch between
these consoles.</p>
<p>Consoles are numbered beginning from 1 and represented as character
devices <code>/dev/ttyN</code>. Only one of them is active at a time. <code>/dev/tty0</code> is
an alias for the currently active console.</p>
<h2 id="textgraphics-mode">Text/graphics mode</h2>
<p>Every console can be in text or graphics mode. In text mode, the VT
subsystem manages text rendering, cursor display and idle blanking.
In graphics mode, the VT subsystem does not do anything. To draw anything
on the screen, the compositor must pick a console and switch it to graphics
mode. On exit, it must restore the previous mode; otherwise the text console
will not be redrawn<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.</p>
<p>The text/graphic mode is selected by <code>ioctl</code> <code>KDSETMODE</code>.</p>
<h2 id="vt-switching">VT switching</h2>
<p>Switching between consoles begins by pressing a special
key<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> (managed by the kernel itself), or by issuing <code>ioctl</code>
<code>VT_ACTIVATE</code><sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>.</p>
<p>The kernel manages the saving and restoring of content for consoles in text mode.
For graphics consoles, the kernel expects applications to self-redraw.</p>
<h2 id="autoprocess-controlled-vt-switching">Auto/process-controlled VT switching</h2>
<p>Every console can be in one of two modes:</p>
<ul>
<li>automatic VT switching,</li>
<li>process-controlled VT switching.</li>
</ul>
<p>The mode is selected by <code>ioctl</code> <code>VT_SETMODE</code> that takes three parameters:</p>
<ul>
<li>the mode: auto or process-controlled<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>,</li>
<li>the signal sent on console deactivation (release signal)</li>
<li>the signal sent on console activation (acquire signal).</li>
</ul>
<p>The process that called this <code>ioctl</code> becomes the console owner.</p>
<p>If the console is in auto mode, nothing happens when it is activated
(switched to) or deactivated (swiched from).</p>
<p>If the console is in process-controlled mode, both its activation
and deactivation are coordinated with the owning process:</p>
<ul>
<li>on deactivation, the kernel sends the release signal to the owning process.
The kernel then waits for that process to call <code>ioctl</code> <code>VT_RELDISP</code>,
marking the console as released.</li>
<li>The same procedure occurs on console activation: the acquire signal is
sent to the owner of the console being switched to.</li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><code>console_ioctl(4)</code></li>
<li><code>seatd</code> source code</li>
<li><code>Xfree86</code> source code</li>
</ul>
<h2 id="footnotes">Footnotes</h2>
<div class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn:1" role="doc-endnote">
<p>For instance, if compositor is started from the virtual console, using
it directly instead of switching to a new one, and without compositor
telling VT to stop drawing, its own stdout and stderr will overwrite
its output.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>If it is not compiled with <code>CONFIG_VT=n</code>.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>Actually, Linux includes a kludge for this situation: whenever console
switch occurs, it checks whether the owning process has died. If it did,
Linux switches the console back to text mode.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>The Linux console input map provides actions &ldquo;switch to console N&rdquo;, &ldquo;switch
to next console&rdquo; and &ldquo;switch to previous console&rdquo;. Typcially, these actions
are bound to key combinations [Ctrl+]Alt+FnX, [Ctrl+]Alt+{Left,Right}.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p>That&rsquo;s how X server and Wayland compositors implement switching to
another VT. They disable the VT console input, so they must handle the
keys themselves.&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p><code>ioctl_console(2)</code> manpage also mentions <code>VT_ACKACQ</code>, but it&rsquo;s not a mode;
instead, it&rsquo;s an argument for <code>VT_RELDISP</code>.&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

  </div>
  <div class="post-meta">
    
<time datetime="2023-07-07T00:00:00Z">
  2023-07-07
</time>

  </div>
</article>

    </div>
  </main>
  

</body>
</html>
