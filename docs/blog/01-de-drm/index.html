
<!doctype html>
<html>
<head>
  
  <meta charset="utf-8">
  <!-- Still needed? -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="author" content="Mikhail Gusarov">
  <title>DE/compositor development notes - Linux DRM devices</title>

  <link rel="stylesheet" href="/styles/main.css">
  <link rel="alternate" type="application/atom+xml" title="Mikhail Gusarov feed" href="../../blog.atom">

  <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-120900398-1">
  </script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-120900398-1');
  </script>

</head>
<body>
  
<header class="site-header" role="banner">
  <div class="wrapper">
    <a class="site-title" href="/">Mikhail Gusarov</a>
    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>
      <div class="trigger">
        <a class="page-link active-page-link" href="/">Blog</a>
        <a class="page-link " href="/cv">CV</a>
        <a class="page-link " href="/keys">Keys</a>
        <a class="page-link " href="/software">Software</a>
        <a class="page-link " href="/contacts">Contacts</a>
      </div>
    </nav>
  </div>
</header>

  <main class="page-content">
    <div class="wrapper">
      
<article class="post">
  <h1>DE/compositor development notes - Linux DRM devices</h1>
  <div class="post-content">
  <p>To draw on the screen, the compositor needs to communicate with the display
controller and GPU<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup><sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<p>Linux exposes them to userspace via DRM subsystem<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>, which presents them
as character devices in <code>/dev/dri</code><sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup><sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup>.</p>
<p>There could be one or two devices per display controller or GPU<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>:</p>
<ul>
<li>there is always a device named <code>card&lt;N&gt;</code> that accepts all requests
for controlling the display (KMS<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>) and rendering operations.
If <code>card&lt;N&gt;</code> belongs to a pure display controller, it won&rsquo;t accept
rendering operations.</li>
<li>GPUs typically have a second device called <code>renderD&lt;N&gt;</code>. It is dedicated
to rendering operations only.</li>
</ul>
<p>Card and render devices for one card do not have the same number in the name.
To match them, use symlinks in <code>/dev/dri/by-path</code>, which are of the format
<code>&lt;unique-id-for-card-&gt;{card,render}</code><sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup><sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup>.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://cgit.freedesktop.org/drm/libdrm/tree/xf86drm.c">libdrm&rsquo;s x86drm.c</a></li>
<li><a href="https://dri.freedesktop.org/docs/drm/gpu/drm-uapi.html">Linux&rsquo;s DRM uAPI documentation</a></li>
</ul>
<h2 id="footnotes">Footnotes</h2>
<div class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn:1" role="doc-endnote">
<p>A display controller is a hardware component that takes bitmaps and displays them.
It handles outputs, links, and modes. A GPU is a hardware component that receives
(3D) rendering commands and creates bitmaps based on these commands. It deals
with triangles, shaders, textures and pixels. In PCs, these two components
are usually colocated in a graphics card. The display controller may need
the bitmaps to be placed in a specialized on-card memory, and the GPU may produce
bitmaps in that specialized memory.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>The <a href="https://cgit.freedesktop.org/drm/libdrm/">libdrm</a> library exists to
hide low-level details from applications. However, it is not a transparent
wrapper, so it is important to understand what it actually does and the
specific syscalls it makes.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p>Direct rendering manager, not digital rights management.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p>DRI stands for &ldquo;direct rendering interface&rdquo;. Linux uses directory <code>/dev/dri</code>
for historical reasons. FreeBSD has changed it to <code>/dev/drm</code>.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5" role="doc-endnote">
<p>These devices used to also be exposed as <code>/proc/dri</code>, but that is no longer the case.&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6" role="doc-endnote">
<p>There used to be a third type of device called <code>controlD&lt;N&gt;</code>, but it was removed because
it did nothing.&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7" role="doc-endnote">
<p>Kernel modesetting is a generic kernel API to configure display controllers,
contrasting with userland modesetting which involves userland poking hardware
directly for display controller configuration.&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8" role="doc-endnote">
<p>It&rsquo;s <code>udev</code> that creates these symlinks.&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9" role="doc-endnote">
<p>The matching of <code>card&lt;N&gt;</code> and <code>renderD&lt;N&gt;</code> devices used to be cumbersome because
their numbers do not correspond. The algorithm for matching was dependent on bus
type, with PCI/USB being matched by PCI/USB bus information, and platform devices
being matched using device tree information. This required searching for the necessary
information in <code>/sys/dev/char/&lt;N&gt;/device/subystem</code>. All of this functionality is
is implemented in <code>libdrm</code>.&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

  </div>
  <div class="post-meta">
    
<time datetime="2023-07-06T00:00:00Z">
  2023-07-06
</time>

  </div>
</article>

    </div>
  </main>
  

</body>
</html>
